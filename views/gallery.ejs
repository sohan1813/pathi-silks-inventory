<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= typeof galleryTitle !== 'undefined' ? galleryTitle : 'Your Gallery' %> - Pathi Silks Inventory</title>
  <link rel="stylesheet" href="/public/style.css" />
  <link rel="manifest" href="/public/manifest.webmanifest" />
  <meta name="theme-color" content="#201a2c" />

  <!-- Multi-select toolbar styles (boss only) -->
  <style>
    .select-toolbar {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      z-index: 10050;
      display: none;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(0,0,0,0.78);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: 0 18px 45px rgba(0,0,0,0.45);
      backdrop-filter: blur(10px);
    }
    .select-toolbar.show { display: flex; }

    .select-toolbar .count {
      font-size: 13px;
      font-weight: 600;
      padding: 0 6px;
      opacity: 0.95;
      white-space: nowrap;
    }

    .select-toolbar button {
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.10);
      color: #fff;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 13px;
      cursor: pointer;
    }
    .select-toolbar button:hover { background: rgba(255,255,255,0.16); }

    .select-toolbar button.primary {
      background: linear-gradient(90deg, #7c3aed, #ec4899);
      border: none;
      box-shadow: 0 10px 26px rgba(236, 72, 153, 0.30);
    }

    /* Selected visual */
    .photo-card.is-selected {
      outline: 4px solid rgba(236, 72, 153, 0.9);
      outline-offset: 0px;
    }
    .photo-card .select-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      font-size: 14px;
      font-weight: 800;
      color: #fff;
      background: rgba(0,0,0,0.45);
      border: 1px solid rgba(255,255,255,0.35);
      backdrop-filter: blur(10px);
      z-index: 5;
      opacity: 0;
      transform: scale(0.92);
      transition: opacity .15s ease, transform .15s ease;
      pointer-events: none;
    }
    .photo-card.is-selected .select-badge {
      opacity: 1;
      transform: scale(1);
      background: rgba(236,72,153,0.85);
      border-color: rgba(255,255,255,0.6);
    }

    /* Disable long-press callout/selection while selecting */
    body.select-mode {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
  </style>
</head>
<body>
  <% if (typeof isAdmin === 'undefined') { isAdmin = false; } %>

  <div class="page">
    <div class="page-inner">
      <header>
        <div class="header-left">
          <img src="/public/pathi-logo.jpg" alt="Pathi Silks logo" class="header-logo">
          <div class="header-title">Pathi Silks Inventory</div>
        </div>
        <nav>
          <% if (!isAdmin) { %>
            <!-- Removed 4 links (Main/Other/Sales/Sheets). Use nav cards instead -->
            <a href="/purchases">üì¶ Stock Purchase</a>
          <% } %>

          <% if (isAdmin) { %>
            <a href="/admin-gallery">üì∏ Admin Gallery</a>
            <a href="/admin-main-gallery">üì∏ Admin Main</a>
            <a href="/admin-other-gallery">üóÇÔ∏è Admin Other</a>
            <a href="/admin-sales-gallery">üí∞ Admin Sales</a>
            <a href="/admin-sheets">üìä Admin Sheets</a>
            <a href="/purchases">üì¶ Stock Purchase</a>
            <a href="/upload">‚¨ÜÔ∏è Upload</a>
          <% } %>

          <button id="themeToggle" class="install-btn">üåô Dark</button>
          <a href="/logout">üö™ Logout</a>
          <button id="installAppBtn" class="install-btn" style="display:none;">Install app</button>
        </nav>
      </header>

      <main>
        <h2 style="margin-top: 8px;"><%= typeof galleryTitle !== 'undefined' ? galleryTitle : 'Your Gallery' %></h2>

        <div class="search-bar">
          <input
            type="text"
            id="gallerySearch"
            placeholder="Search brand, person or date‚Ä¶ (e.g. Pathi, Tanya, 2024-02-22)"
          />
        </div>

        <% if (!brands || brands.length === 0) { %>
          <p>No folders yet.</p>
        <% } else { %>
          <!-- Jumper bar after search bar -->
          <div class="jumper-bar">
            <div>
              <label for="brandSelect">Jump to brand:</label>
              <select id="brandSelect">
                <option value="">All brands</option>
                <% brands.forEach(function (b) { %>
                  <option value="brand-<%= b.name.replace(/\s+/g, '-') %>"><%= b.name %></option>
                <% }); %>
              </select>
            </div>
            <div>
              <label for="personSelect">Jump to person:</label>
              <select id="personSelect">
                <option value="">All persons</option>
                <% brands.forEach(function (b) { %>
                  <% b.persons.forEach(function (p) { %>
                    <option value="person-<%= b.name.replace(/\s+/g, '-') %>-<%= p.name.replace(/\s+/g, '-') %>">
                      <%= b.name %> ‚Äì <%= p.name %>
                    </option>
                  <% }); %>
                <% }); %>
              </select>
            </div>
            <div>
              <label for="dateSelect">Jump to date:</label>
              <select id="dateSelect">
                <option value="">All dates</option>
                <% brands.forEach(function (b) { %>
                  <% b.persons.forEach(function (p) { %>
                    <% p.dates.forEach(function (d) { %>
                      <option value="date-<%= b.name.replace(/\s+/g, '-') %>-<%= p.name.replace(/\s+/g, '-') %>-<%= d.name %>">
                        <%= b.name %> ‚Äì <%= p.name %> ‚Äì <%= d.name %>
                      </option>
                    <% }); %>
                  <% }); %>
                <% }); %>
              </select>
            </div>
          </div>

          <!-- Nav image cards (inside scroll wrapper for carousel effect) -->
          <div class="nav-cards-scroll">
            <div class="nav-cards">
              <button class="nav-card" onclick="window.location.href='<%= isAdmin ? '/admin-gallery' : '/gallery' %>'">
                <img src="/public/nav-main.jpg" alt="Main Gallery" class="nav-card-img" />
                <div class="nav-card-overlay">
                  <div class="nav-card-title">Main Gallery</div>
                  <div class="nav-card-sub">All main saree & blouse sets</div>
                </div>
              </button>

              <button class="nav-card" onclick="window.location.href='<%= isAdmin ? '/admin-other-gallery' : '/other-gallery' %>'">
                <img src="/public/nav-other.jpg" alt="Other Albums" class="nav-card-img" />
                <div class="nav-card-overlay">
                  <div class="nav-card-title">Other Albums</div>
                  <div class="nav-card-sub">Special shoots & extras</div>
                </div>
              </button>

              <button class="nav-card" onclick="window.location.href='<%= isAdmin ? '/admin-other2-gallery' : '/other-gallery-2' %>'">
                <img src="/public/nav-other2.jpg" alt="Other Albums 2" class="nav-card-img" />
                <div class="nav-card-overlay">
                  <div class="nav-card-title">Other Albums 2</div>
                  <div class="nav-card-sub">More special shoots</div>
                </div>
              </button>

              <button class="nav-card" onclick="window.location.href='<%= isAdmin ? '/admin-sales-gallery' : '/sales-gallery' %>'">
                <img src="/public/nav-sales.jpg" alt="Sales" class="nav-card-img" />
                <div class="nav-card-overlay">
                  <div class="nav-card-title">Sales</div>
                  <div class="nav-card-sub">Ready for billing</div>
                </div>
              </button>

              <button class="nav-card" onclick="window.location.href='<%= isAdmin ? '/admin-sheets' : '/sheets' %>'">
                <img src="/public/nav-sheets.jpg" alt="Sheets" class="nav-card-img" />
                <div class="nav-card-overlay">
                  <div class="nav-card-title">Sheets</div>
                  <div class="nav-card-sub">Sales & stock sheets</div>
                </div>
              </button>
            </div>
          </div>

          <div class="albums">
            <% brands.forEach(function (brand) { %>
              <section class="album" id="brand-<%= brand.name.replace(/\s+/g, '-') %>">
                <h2><%= brand.name %></h2>

                <% brand.persons.forEach(function (person) { %>
                  <section class="person-block" id="person-<%= brand.name.replace(/\s+/g, '-') %>-<%= person.name.replace(/\s+/g, '-') %>">
                    <h3><%= person.name %></h3>

                    <% person.dates.forEach(function (date) { %>
                      <div class="date-block" id="date-<%= brand.name.replace(/\s+/g, '-') %>-<%= person.name.replace(/\s+/g, '-') %>-<%= date.name %>">
                        <h4><%= date.name %></h4>
                        <div class="photos">
                          <% date.files.forEach(function (file) { %>
                            <!-- Added data-src + data-name + badge (boss selection) -->
                            <div class="photo-card"
                                 data-src="<%= file.src %>"
                                 data-name="<%= file.name %>">
                              <% if (!isAdmin) { %>
                                <div class="select-badge">‚úì</div>
                              <% } %>

                              <img src="<%= file.src %>" alt="<%= file.name %>" class="lb-img" />
                              <div class="photo-card-inner">
                                <div class="photo-filename"><%= file.name %></div>

                                <% if (isAdmin) { %>
                                  <div class="photo-actions">
                                    <form
                                      method="POST"
                                      action="/rename-photo"
                                      class="rename-form"
                                      data-oldfilename="<%= file.name %>"
                                    >
                                      <input type="hidden" name="brand" value="<%= brand.name %>" />
                                      <input type="hidden" name="person" value="<%= person.name %>" />
                                      <input type="hidden" name="date" value="<%= date.name %>" />
                                      <input type="hidden" name="oldfilename" value="<%= file.name %>" />
                                      <input
                                        type="text"
                                        name="newfilename"
                                        placeholder="New name"
                                        class="rename-input"
                                        required
                                      />
                                      <button type="submit" class="rename-btn">Rename</button>
                                    </form>

                                    <form method="POST" action="/delete-photo" class="delete-form">
                                      <input type="hidden" name="brand" value="<%= brand.name %>" />
                                      <input type="hidden" name="person" value="<%= person.name %>" />
                                      <input type="hidden" name="date" value="<%= date.name %>" />
                                      <input type="hidden" name="filename" value="<%= file.name %>" />
                                      <button type="submit" class="delete-btn">Delete</button>
                                    </form>
                                  </div>
                                <% } %>
                              </div>
                            </div>
                          <% }); %>
                        </div>
                      </div>
                    <% }); %>
                  </section>
                <% }); %>
              </section>
            <% }); %>
          </div>
        <% } %>
      </main>

      <!-- Image lightbox -->
      <div id="lightbox" class="lightbox">
        <span id="lightbox-close" class="lightbox-close">&times;</span>
        <span id="lightbox-prev" class="lightbox-arrow lightbox-prev">‚ùÆ</span>
        <span id="lightbox-next" class="lightbox-arrow lightbox-next">‚ùØ</span>
        <div class="lightbox-content">
          <img id="lightbox-img" src="" alt="">
        </div>
      </div>
    </div>
  </div>

  <!-- Boss multi-select toolbar -->
  <% if (!isAdmin) { %>
    <div id="selectToolbar" class="select-toolbar">
      <div id="selectCount" class="count">0 selected</div>
      <button id="btnShare" class="primary" type="button">Share</button>
      <button id="btnDownload" type="button">Download</button>
      <button id="btnCancel" type="button">Cancel</button>
    </div>
  <% } %>

  <script src="/public/lightbox.js"></script>

  <script>
    // Theme toggle: light -> dark -> brown -> blue -> light
    (function () {
      const themeBtn = document.getElementById('themeToggle');
      const themes = ['light', 'dark', 'brown', 'blue'];
      const labels = {
        light: 'üåô Dark',
        dark: 'ü§é Brown',
        brown: 'üíô Blue',
        blue: '‚òÄÔ∏è Light',
      };

      function applyTheme(theme) {
        document.body.classList.remove('dark-mode', 'brown-mode', 'blue-mode');

        if (theme === 'dark') document.body.classList.add('dark-mode');
        if (theme === 'brown') document.body.classList.add('brown-mode');
        if (theme === 'blue') document.body.classList.add('blue-mode');

        if (themeBtn) themeBtn.textContent = labels[theme] || 'üåô Dark';
        localStorage.setItem('theme', theme);
      }

      let current = localStorage.getItem('theme') || 'light';
      if (!themes.includes(current)) current = 'light';
      applyTheme(current);

      if (themeBtn) {
        themeBtn.addEventListener('click', () => {
          const idx = themes.indexOf(current);
          const next = themes[(idx + 1) % themes.length];
          current = next;
          applyTheme(current);
        });
      }
    })();

    // Jumpers + search
    document.addEventListener('DOMContentLoaded', function () {
      const brandSelect = document.getElementById('brandSelect');
      const personSelect = document.getElementById('personSelect');
      const dateSelect = document.getElementById('dateSelect');

      function jumpTo(id) {
        if (!id) return;
        const el = document.getElementById(id);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      if (brandSelect) {
        brandSelect.addEventListener('change', function () {
          jumpTo(this.value);
        });
      }
      if (personSelect) {
        personSelect.addEventListener('change', function () {
          jumpTo(this.value);
        });
      }
      if (dateSelect) {
        dateSelect.addEventListener('change', function () {
          jumpTo(this.value);
        });
      }

      const searchInput = document.getElementById('gallerySearch');

      function normalize(str) {
        return str.toLowerCase();
      }

      function applySearch() {
        const term = normalize(searchInput.value.trim());
        const brandSections = document.querySelectorAll('.album');

        if (!term) {
          brandSections.forEach(sec => sec.style.display = '');
          return;
        }

        brandSections.forEach(sec => {
          const brandName = normalize(sec.querySelector('h2').textContent || '');
          const personBlocks = sec.querySelectorAll('.person-block');
          let brandHasMatch = false;

          personBlocks.forEach(pb => {
            const personName = normalize(pb.querySelector('h3').textContent || '');
            const dateBlocks = pb.querySelectorAll('.date-block');
            let personHasMatch = false;

            dateBlocks.forEach(db => {
              const dateText = normalize(db.querySelector('h4').textContent || '');
              const combined = brandName + ' ' + personName + ' ' + dateText;
              const match = combined.includes(term);
              db.style.display = match ? '' : 'none';
              if (match) personHasMatch = true;
            });

            pb.style.display = personHasMatch ? '' : 'none';
            if (personHasMatch) brandHasMatch = true;
          });

          sec.style.display = brandHasMatch ? '' : 'none';
        });
      }

      if (searchInput) {
        searchInput.addEventListener('input', applySearch);
      }
    });
  </script>

  <!-- Boss: multi-select + share/download -->
  <% if (!isAdmin) { %>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const cards = Array.from(document.querySelectorAll('.photo-card'));
      const toolbar = document.getElementById('selectToolbar');
      const countEl = document.getElementById('selectCount');
      const btnShare = document.getElementById('btnShare');
      const btnDownload = document.getElementById('btnDownload');
      const btnCancel = document.getElementById('btnCancel');

      let selectMode = false;
      const selected = new Set();

      function setSelectMode(on) {
        selectMode = on;
        document.body.classList.toggle('select-mode', on);
        if (!toolbar) return;
        toolbar.classList.toggle('show', on);
        if (!on) {
          selected.clear();
          cards.forEach(c => c.classList.remove('is-selected'));
        }
        updateCount();
      }

      function updateCount() {
        if (!countEl) return;
        countEl.textContent = `${selected.size} selected`;
        if (btnShare) btnShare.disabled = selected.size === 0;
        if (btnDownload) btnDownload.disabled = selected.size === 0;
      }

      function toggleCard(card) {
        const key = card.dataset.src;
        if (!key) return;

        if (selected.has(key)) {
          selected.delete(key);
          card.classList.remove('is-selected');
        } else {
          selected.add(key);
          card.classList.add('is-selected');
        }
        updateCount();
      }

      // Long press detection (mouse + touch) [web:627]
      let pressTimer = null;
      let longPressed = false;

      function startPress(card, e) {
        longPressed = false;
        clearTimeout(pressTimer);
        pressTimer = setTimeout(() => {
          longPressed = true;
          if (!selectMode) setSelectMode(true);
          toggleCard(card);
        }, 600);
      }
      function cancelPress() {
        clearTimeout(pressTimer);
        pressTimer = null;
      }

      cards.forEach((card) => {
        // mouse
        card.addEventListener('mousedown', (e) => startPress(card, e));
        card.addEventListener('mouseup', cancelPress);
        card.addEventListener('mouseleave', cancelPress);

        // touch
        card.addEventListener('touchstart', (e) => startPress(card, e), { passive: true });
        card.addEventListener('touchend', cancelPress);
        card.addEventListener('touchcancel', cancelPress);

        // click behavior: if selecting -> toggle, else allow normal (lightbox)
        card.addEventListener('click', (e) => {
          if (!selectMode) return; // let lightbox.js handle normal clicks
          e.preventDefault();
          e.stopPropagation();
          toggleCard(card);
        });
      });

      async function getSelectedFiles() {
        const urls = Array.from(selected);
        const files = [];

        for (let i = 0; i < urls.length; i++) {
          const url = urls[i];
          const card = cards.find(c => c.dataset.src === url);
          const name = (card && card.dataset.name) ? card.dataset.name : `image-${i + 1}.jpg`;

          const res = await fetch(url, { cache: 'no-store' });
          const blob = await res.blob();
          const type = blob.type || 'image/jpeg';
          files.push(new File([blob], name, { type }));
        }
        return files;
      }

      btnCancel?.addEventListener('click', () => setSelectMode(false));

      // ‚úÖ UPDATED: Download using fetch -> blob -> objectURL (reliable)
      btnDownload?.addEventListener('click', async () => {
        try {
          const urls = Array.from(selected);

          for (let i = 0; i < urls.length; i++) {
            const url = urls[i];
            const card = cards.find(c => c.dataset.src === url);
            const filename = (card && card.dataset.name) ? card.dataset.name : `image-${i + 1}.jpg`;

            const res = await fetch(url, { cache: 'no-store' });
            if (!res.ok) throw new Error(`Download failed (${res.status})`);

            const blob = await res.blob();
            const blobUrl = URL.createObjectURL(blob); // [web:728]

            const a = document.createElement('a');
            a.href = blobUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();

            // wait a bit before revoking to avoid Chrome issues [web:721]
            setTimeout(() => URL.revokeObjectURL(blobUrl), 2000); // [web:723]

            await new Promise(r => setTimeout(r, 250));
          }
        } catch (err) {
          alert(err?.message || 'Download failed');
        }
      });

      btnShare?.addEventListener('click', async () => {
        try {
          const files = await getSelectedFiles();
          const shareData = { files, title: 'Pathi Silks', text: `Photos (${files.length})` };

          if (navigator.canShare && navigator.canShare({ files })) {
            await navigator.share(shareData);
          } else {
            alert("Sharing files not supported on this device/browser. Use Download instead.");
          }
        } catch (err) {
          alert(err?.message || 'Share failed');
        }
      });

      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && selectMode) setSelectMode(false);
      });

      setSelectMode(false);
    });
  </script>
  <% } %>

  <!-- Rename without page reload -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const renameForms = document.querySelectorAll('form.rename-form');

      renameForms.forEach((form) => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          const btn = form.querySelector('button.rename-btn');
          const input = form.querySelector('input[name="newfilename"]');
          const oldHidden = form.querySelector('input[name="oldfilename"]');

          const prevBtnText = btn ? btn.textContent : '';
          if (btn) {
            btn.disabled = true;
            btn.textContent = '...';
          }

          try {
            const fd = new FormData(form);

            const res = await fetch(form.action, {
              method: 'POST',
              body: fd,
              headers: { 'Accept': 'application/json' }
            });

            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'Rename failed');

            const card = form.closest('.photo-card');
            if (card) {
              const nameEl = card.querySelector('.photo-filename');
              if (nameEl) nameEl.textContent = data.newfilename;
            }

            if (oldHidden) oldHidden.value = data.newfilename;
            form.dataset.oldfilename = data.newfilename;

            if (input) input.value = '';
            if (input) input.focus();
          } catch (err) {
            alert(err.message || 'Rename failed');
          } finally {
            if (btn) {
              btn.disabled = false;
              btn.textContent = prevBtnText || 'Rename';
            }
          }
        });
      });
    });
  </script>

  <!-- NEW: Delete without page reload -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const deleteForms = document.querySelectorAll('form.delete-form');

      deleteForms.forEach((form) => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          if (!confirm('Delete this photo?')) return;

          const btn = form.querySelector('button.delete-btn');
          const prevText = btn ? btn.textContent : '';

          if (btn) {
            btn.disabled = true;
            btn.textContent = '...';
          }

          try {
            const fd = new FormData(form);

            const res = await fetch(form.action, {
              method: 'POST',
              body: fd,
              headers: { 'Accept': 'application/json' }
            });

            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'Delete failed');

            const card = form.closest('.photo-card');
            if (card) card.remove();
          } catch (err) {
            alert(err.message || 'Delete failed');
            if (btn) {
              btn.disabled = false;
              btn.textContent = prevText || 'Delete';
            }
          }
        });
      });
    });
  </script>
</body>
</html>
