<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= typeof galleryTitle !== 'undefined' ? galleryTitle : 'Your Gallery' %> - Pathi Silks Inventory</title>
  <link rel="stylesheet" href="/public/style.css" />
  <link rel="manifest" href="/public/manifest.webmanifest" />
  <meta name="theme-color" content="#201a2c" />
</head>
<body>
  <% if (typeof isAdmin === 'undefined') { isAdmin = false; } %>

  <div class="page">
    <div class="page-inner">
      <header>
        <div class="header-left">
          <img src="/public/pathi-logo.jpg" alt="Pathi Silks logo" class="header-logo">
          <div class="header-title">Pathi Silks Inventory</div>
        </div>
        <nav>
          <% if (!isAdmin) { %>
            <a href="/gallery">üì∏ Main Gallery</a>
            <a href="/other-gallery">üóÇÔ∏è Other Albums</a>
            <a href="/sales-gallery">üí∞ Sales</a>
            <a href="/sheets">üìä Sheets</a>
            <a href="/purchases">üì¶ Stock Purchase</a>
          <% } %>

          <% if (isAdmin) { %>
            <a href="/admin-gallery">üì∏ Admin Gallery</a>
            <a href="/admin-main-gallery">üì∏ Admin Main</a>
            <a href="/admin-other-gallery">üóÇÔ∏è Admin Other</a>
            <a href="/admin-sales-gallery">üí∞ Admin Sales</a>
            <a href="/admin-sheets">üìä Admin Sheets</a>
            <a href="/purchases">üì¶ Stock Purchase</a>
            <a href="/upload">‚¨ÜÔ∏è Upload</a>
          <% } %>

          <button id="themeToggle" class="install-btn">üåô Dark</button>
          <a href="/logout">üö™ Logout</a>
          <button id="installAppBtn" class="install-btn" style="display:none;">Install app</button>
        </nav>
      </header>

      <main>
        <h2 style="margin-top: 8px;"><%= typeof galleryTitle !== 'undefined' ? galleryTitle : 'Your Gallery' %></h2>

        <div class="search-bar">
          <input
            type="text"
            id="gallerySearch"
            placeholder="Search brand, person or date‚Ä¶ (e.g. Pathi, Tanya, 2024-02-22)"
          />
        </div>

        <% if (!brands || brands.length === 0) { %>
          <p>No folders yet.</p>
        <% } else { %>
          <!-- Jumper bar after search bar -->
          <div class="jumper-bar">
            <div>
              <label for="brandSelect">Jump to brand:</label>
              <select id="brandSelect">
                <option value="">All brands</option>
                <% brands.forEach(function (b) { %>
                  <option value="brand-<%= b.name.replace(/\s+/g, '-') %>"><%= b.name %></option>
                <% }); %>
              </select>
            </div>
            <div>
              <label for="personSelect">Jump to person:</label>
              <select id="personSelect">
                <option value="">All persons</option>
                <% brands.forEach(function (b) { %>
                  <% b.persons.forEach(function (p) { %>
                    <option value="person-<%= b.name.replace(/\s+/g, '-') %>-<%= p.name.replace(/\s+/g, '-') %>">
                      <%= b.name %> ‚Äì <%= p.name %>
                    </option>
                  <% }); %>
                <% }); %>
              </select>
            </div>
            <div>
              <label for="dateSelect">Jump to date:</label>
              <select id="dateSelect">
                <option value="">All dates</option>
                <% brands.forEach(function (b) { %>
                  <% b.persons.forEach(function (p) { %>
                    <% p.dates.forEach(function (d) { %>
                      <option value="date-<%= b.name.replace(/\s+/g, '-') %>-<%= p.name.replace(/\s+/g, '-') %>-<%= d.name %>">
                        <%= b.name %> ‚Äì <%= p.name %> ‚Äì <%= d.name %>
                      </option>
                    <% }); %>
                  <% }); %>
                <% }); %>
              </select>
            </div>
          </div>

          <!-- Nav image cards (inside scroll wrapper for carousel effect) -->
          <div class="nav-cards-scroll">
            <div class="nav-cards">
              <button class="nav-card" onclick="window.location.href='<%= isAdmin ? '/admin-gallery' : '/gallery' %>'">
                <img src="/public/nav-main.jpg" alt="Main Gallery" class="nav-card-img" />
                <div class="nav-card-overlay">
                  <div class="nav-card-title">Main Gallery</div>
                  <div class="nav-card-sub">All main saree & blouse sets</div>
                </div>
              </button>

              <button class="nav-card" onclick="window.location.href='<%= isAdmin ? '/admin-other-gallery' : '/other-gallery' %>'">
                <img src="/public/nav-other.jpg" alt="Other Albums" class="nav-card-img" />
                <div class="nav-card-overlay">
                  <div class="nav-card-title">Other Albums</div>
                  <div class="nav-card-sub">Special shoots & extras</div>
                </div>
              </button>

              <button class="nav-card" onclick="window.location.href='<%= isAdmin ? '/admin-other2-gallery' : '/other-gallery-2' %>'">
                <img src="/public/nav-other2.jpg" alt="Other Albums 2" class="nav-card-img" />
                <div class="nav-card-overlay">
                  <div class="nav-card-title">Other Albums 2</div>
                  <div class="nav-card-sub">More special shoots</div>
                </div>
              </button>

              <button class="nav-card" onclick="window.location.href='<%= isAdmin ? '/admin-sales-gallery' : '/sales-gallery' %>'">
                <img src="/public/nav-sales.jpg" alt="Sales" class="nav-card-img" />
                <div class="nav-card-overlay">
                  <div class="nav-card-title">Sales</div>
                  <div class="nav-card-sub">Ready for billing</div>
                </div>
              </button>

              <button class="nav-card" onclick="window.location.href='<%= isAdmin ? '/admin-sheets' : '/sheets' %>'">
                <img src="/public/nav-sheets.jpg" alt="Sheets" class="nav-card-img" />
                <div class="nav-card-overlay">
                  <div class="nav-card-title">Sheets</div>
                  <div class="nav-card-sub">Sales & stock sheets</div>
                </div>
              </button>
            </div>
          </div>

          <div class="albums">
            <% brands.forEach(function (brand) { %>
              <section class="album" id="brand-<%= brand.name.replace(/\s+/g, '-') %>">
                <h2><%= brand.name %></h2>

                <% brand.persons.forEach(function (person) { %>
                  <section class="person-block" id="person-<%= brand.name.replace(/\s+/g, '-') %>-<%= person.name.replace(/\s+/g, '-') %>">
                    <h3><%= person.name %></h3>

                    <% person.dates.forEach(function (date) { %>
                      <div class="date-block" id="date-<%= brand.name.replace(/\s+/g, '-') %>-<%= person.name.replace(/\s+/g, '-') %>-<%= date.name %>">
                        <h4><%= date.name %></h4>
                        <div class="photos">
                          <% date.files.forEach(function (file) { %>
                            <div class="photo-card">
                              <img src="<%= file.src %>" alt="<%= file.name %>" class="lb-img" />
                              <div class="photo-card-inner">
                                <div class="photo-filename"><%= file.name %></div>

                                <% if (isAdmin) { %>
                                  <div class="photo-actions">
                                    <form
                                      method="POST"
                                      action="/rename-photo"
                                      class="rename-form"
                                      data-oldfilename="<%= file.name %>"
                                    >
                                      <input type="hidden" name="brand" value="<%= brand.name %>" />
                                      <input type="hidden" name="person" value="<%= person.name %>" />
                                      <input type="hidden" name="date" value="<%= date.name %>" />
                                      <input type="hidden" name="oldfilename" value="<%= file.name %>" />
                                      <input
                                        type="text"
                                        name="newfilename"
                                        placeholder="New name"
                                        class="rename-input"
                                        required
                                      />
                                      <button type="submit" class="rename-btn">Rename</button>
                                    </form>

                                    <form method="POST" action="/delete-photo" class="delete-form">
                                      <input type="hidden" name="brand" value="<%= brand.name %>" />
                                      <input type="hidden" name="person" value="<%= person.name %>" />
                                      <input type="hidden" name="date" value="<%= date.name %>" />
                                      <input type="hidden" name="filename" value="<%= file.name %>" />
                                      <button type="submit" class="delete-btn">Delete</button>
                                    </form>
                                  </div>
                                <% } %>
                              </div>
                            </div>
                          <% }); %>
                        </div>
                      </div>
                    <% }); %>
                  </section>
                <% }); %>
              </section>
            <% }); %>
          </div>
        <% } %>
      </main>

      <!-- Image lightbox -->
      <div id="lightbox" class="lightbox">
        <span id="lightbox-close" class="lightbox-close">&times;</span>
        <span id="lightbox-prev" class="lightbox-arrow lightbox-prev">‚ùÆ</span>
        <span id="lightbox-next" class="lightbox-arrow lightbox-next">‚ùØ</span>
        <div class="lightbox-content">
          <img id="lightbox-img" src="" alt="">
        </div>
      </div>
    </div>
  </div>

  <script src="/public/lightbox.js"></script>

  <script>
    // Theme toggle: light -> dark -> brown -> blue -> light
    (function () {
      const themeBtn = document.getElementById('themeToggle');
      const themes = ['light', 'dark', 'brown', 'blue'];
      const labels = {
        light: 'üåô Dark',
        dark: 'ü§é Brown',
        brown: 'üíô Blue',
        blue: '‚òÄÔ∏è Light',
      };

      function applyTheme(theme) {
        document.body.classList.remove('dark-mode', 'brown-mode', 'blue-mode');

        if (theme === 'dark') document.body.classList.add('dark-mode');
        if (theme === 'brown') document.body.classList.add('brown-mode');
        if (theme === 'blue') document.body.classList.add('blue-mode');

        if (themeBtn) themeBtn.textContent = labels[theme] || 'üåô Dark';
        localStorage.setItem('theme', theme);
      }

      let current = localStorage.getItem('theme') || 'light';
      if (!themes.includes(current)) current = 'light';
      applyTheme(current);

      if (themeBtn) {
        themeBtn.addEventListener('click', () => {
          const idx = themes.indexOf(current);
          const next = themes[(idx + 1) % themes.length];
          current = next;
          applyTheme(current);
        });
      }
    })();

    // Jumpers + search
    document.addEventListener('DOMContentLoaded', function () {
      const brandSelect = document.getElementById('brandSelect');
      const personSelect = document.getElementById('personSelect');
      const dateSelect = document.getElementById('dateSelect');

      function jumpTo(id) {
        if (!id) return;
        const el = document.getElementById(id);
        if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      if (brandSelect) {
        brandSelect.addEventListener('change', function () {
          jumpTo(this.value);
        });
      }
      if (personSelect) {
        personSelect.addEventListener('change', function () {
          jumpTo(this.value);
        });
      }
      if (dateSelect) {
        dateSelect.addEventListener('change', function () {
          jumpTo(this.value);
        });
      }

      const searchInput = document.getElementById('gallerySearch');

      function normalize(str) {
        return str.toLowerCase();
      }

      function applySearch() {
        const term = normalize(searchInput.value.trim());
        const brandSections = document.querySelectorAll('.album');

        if (!term) {
          brandSections.forEach(sec => sec.style.display = '');
          return;
        }

        brandSections.forEach(sec => {
          const brandName = normalize(sec.querySelector('h2').textContent || '');
          const personBlocks = sec.querySelectorAll('.person-block');
          let brandHasMatch = false;

          personBlocks.forEach(pb => {
            const personName = normalize(pb.querySelector('h3').textContent || '');
            const dateBlocks = pb.querySelectorAll('.date-block');
            let personHasMatch = false;

            dateBlocks.forEach(db => {
              const dateText = normalize(db.querySelector('h4').textContent || '');
              const combined = brandName + ' ' + personName + ' ' + dateText;
              const match = combined.includes(term);
              db.style.display = match ? '' : 'none';
              if (match) personHasMatch = true;
            });

            pb.style.display = personHasMatch ? '' : 'none';
            if (personHasMatch) brandHasMatch = true;
          });

          sec.style.display = brandHasMatch ? '' : 'none';
        });
      }

      if (searchInput) {
        searchInput.addEventListener('input', applySearch);
      }
    });
  </script>

  <!-- Rename without page reload -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const renameForms = document.querySelectorAll('form.rename-form');

      renameForms.forEach((form) => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault(); // stop normal form submit (no reload) [web:219]

          const btn = form.querySelector('button.rename-btn');
          const input = form.querySelector('input[name="newfilename"]');
          const oldHidden = form.querySelector('input[name="oldfilename"]');

          const prevBtnText = btn ? btn.textContent : '';
          if (btn) {
            btn.disabled = true;
            btn.textContent = '...';
          }

          try {
            const fd = new FormData(form); // build form payload [web:192]

            const res = await fetch(form.action, {
              method: 'POST',
              body: fd,
              headers: { 'Accept': 'application/json' }
            });

            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'Rename failed');

            // Update visible filename
            const card = form.closest('.photo-card');
            if (card) {
              const nameEl = card.querySelector('.photo-filename');
              if (nameEl) nameEl.textContent = data.newfilename;
            }

            // IMPORTANT: update hidden oldfilename so the next rename works without reload
            if (oldHidden) oldHidden.value = data.newfilename;
            form.dataset.oldfilename = data.newfilename;

            // Clear input for faster next rename
            if (input) input.value = '';
            if (input) input.focus();
          } catch (err) {
            alert(err.message || 'Rename failed');
          } finally {
            if (btn) {
              btn.disabled = false;
              btn.textContent = prevBtnText || 'Rename';
            }
          }
        });
      });
    });
  </script>

  <!-- NEW: Delete without page reload -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const deleteForms = document.querySelectorAll('form.delete-form');

      deleteForms.forEach((form) => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault(); // stop normal form submit (no reload) [web:219]

          if (!confirm('Delete this photo?')) return; // confirm dialog [web:276]

          const btn = form.querySelector('button.delete-btn');
          const prevText = btn ? btn.textContent : '';

          if (btn) {
            btn.disabled = true;
            btn.textContent = '...';
          }

          try {
            const fd = new FormData(form); // build payload [web:192]

            const res = await fetch(form.action, {
              method: 'POST',
              body: fd,
              headers: { 'Accept': 'application/json' }
            });

            const data = await res.json();
            if (!data.ok) throw new Error(data.error || 'Delete failed');

            // Remove photo card from UI
            const card = form.closest('.photo-card');
            if (card) card.remove(); // [web:269]
          } catch (err) {
            alert(err.message || 'Delete failed');
            if (btn) {
              btn.disabled = false;
              btn.textContent = prevText || 'Delete';
            }
          }
        });
      });
    });
  </script>
</body>
</html>
